{% extends "base.html" %}
{% load static %}
{% block content %}
<div class="row justify-content-center">
  <div class="col-md-8">
    <div class="card mt-4 p-3">
      <h4 class="text-center"> Mental Health Companion</h4>
      <div id="chat-window" class="chat-window" style="height:400px; overflow:auto; border:1px solid #eee; padding:10px; border-radius:8px;">
        
      </div>

      <div class="mt-3">
        <textarea id="user-input" class="form-control" rows="2" placeholder="How are you feeling today?"></textarea>
        <button id="send-btn" class="btn btn-primary mt-2 w-100">Send</button>
      </div>

      <div class="mt-3 small text-muted">
        <strong>Disclaimer:</strong> This companion is NOT a replacement for professional mental health care. If you are in crisis or thinking about self-harm, contact your local emergency services immediately or a suicide hotline.
      </div>
    </div>
  </div>
</div>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const chatWindow = document.getElementById('chat-window');
    const userInput = document.getElementById('user-input');
    const sendBtn = document.getElementById('send-btn');
    
    
    function addMessage(sender, text, mood = null) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `mb-2 ${sender === 'user' ? 'text-end' : 'text-start'}`;
        
        let moodBadge = '';
        if (mood && mood.label) {
            const badgeClass = mood.label.toLowerCase() === 'positive' ? 'bg-success' : 
                             mood.label.toLowerCase() === 'negative' ? 'bg-danger' : 'bg-secondary';
            moodBadge = `<span class="badge ${badgeClass} ms-2">${mood.label}</span>`;
        }
        
        messageDiv.innerHTML = `
            <div class="d-inline-block p-2 rounded ${sender === 'user' ? 'bg-primary text-white' : 'bg-light'}">
                <strong>${sender === 'user' ? 'You' : 'AI Companion'}:</strong> ${text}${moodBadge}
            </div>
        `;
        
        chatWindow.appendChild(messageDiv);
        chatWindow.scrollTop = chatWindow.scrollHeight;
    }
    
    function sendMessage() {
        const message = userInput.value.trim();
        if (!message) return;
        
        addMessage('user', message);
        userInput.value = '';
        sendBtn.disabled = true;
        sendBtn.textContent = 'Sending...';
        
        fetch('/api/chat/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ message: message })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.error) {
                addMessage('system', 'Error: ' + data.error);
            } else {
                addMessage('ai', data.ai_response, data.mood);
            }
        })
        .catch(error => {
            addMessage('system', `Network error: ${error.message}. Please check your connection and try again.`);
            console.error('Fetch Error:', error);
        })
        .finally(() => {
            sendBtn.disabled = false;
            sendBtn.textContent = 'Send';
        });
    }
    
    sendBtn.addEventListener('click', sendMessage);
    userInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });
});
</script>
{% endblock %}
